<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin panel</title>
    <meta name="_csrf" content="${_csrf.token}">
    <meta name="_csrf_header" content="${_csrf.headerName}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body class="bg-dark text-white">

<!-- Navbar -->
<nav class="navbar navbar-dark bg-dark fixed-top">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">
            <span th:text="${currentUserEmail}"></span>
            with roles : <span th:each="role : ${roles}" th:text="${role} + ' '"></span>
        </a>
        <form th:action="@{/logout}" method="post" class="d-flex">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <button type="submit" class="btn btn-outline-danger">Log Out</button>
        </form>
    </div>
    </div>
    </div>
</nav>
<br><br><br>

<!-- Navbar -->


<br>
<div class="row">
    <div class="col-2">
        <div class="list-group" id="list-tab" role="tablist">
            <a class="btn btn-outline-danger" id="list-home-list" data-bs-toggle="list" href="#list-home" role="tab"
               aria-controls="list-home">Admin</a>
<!--            <a class="btn btn-outline-danger" id="list-profile-list" data-bs-toggle="list" href="#list-profile"-->
<!--               role="tab" aria-controls="list-profile">User</a>-->
        </div>
    </div>
    <div class="col-8">
        <div class="tab-content" id="nav-tabContent">

            <!--Admin-->
            <div class="tab-pane fade show active" id="list-home" role="tabpanel" aria-labelledby="list-home-list">
                <div class="container mt-5">
                    <h2 class="mb-4">Admin Panel</h2>

                    <ul class="nav nav-tabs" id="adminTabs">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" href="#usersTab">User Table</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" href="#newUserTab">New User</a>
                        </li>
                    </ul>

                    <div class="tab-content mt-3">
                        <!-- Users Table -->
                        <div class="tab-pane fade show active" id="usersTab">
                            <table class="table table-dark table-striped table-hover" id="usersTable">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Last Name</th>
                                    <th>Age</th>
                                    <th>Email</th>
                                    <th>Roles</th>
                                    <th>Actions</th>
                                </tr>
                                </thead>
                                <tbody id="usersTableBody"></tbody>
                            </table>

                            <!-- Модалка редактирования -->
                            <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel"
                                 aria-hidden="true">
                                <div class="modal-dialog">
                                    <div class="modal-content bg-dark text-white">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="editModalLabel">Edit User</h5>
                                            <button type="button" class="btn-close btn-close-white"
                                                    data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <form onsubmit="submitEditForm(event)">
                                            <div class="modal-body">
                                                <input type="hidden" id="edit-id">
                                                <div class="mb-3">
                                                    <label class="form-label">First Name</label>
                                                    <input type="text" class="form-control" id="edit-firstName"
                                                           required>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Last Name</label>
                                                    <input type="text" class="form-control" id="edit-lastname" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Age</label>
                                                    <input type="number" class="form-control" id="edit-age" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Email</label>
                                                    <input type="email" class="form-control" id="edit-email" required>
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Password</label>
                                                    <input type="password" class="form-control" id="edit-password">
                                                </div>
                                                <div class="mb-3">
                                                    <label class="form-label">Roles</label>
                                                    <select multiple class="form-select" id="edit-roles">
                                                        <option value="USER">USER</option>
                                                        <option value="ADMIN">ADMIN</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                                    Cancel
                                                </button>
                                                <button type="submit" class="btn btn-primary">Save changes</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <!-- Модалка редактирования -->

                        </div>

                        <!-- New User Form -->
                        <div class="tab-pane fade" id="newUserTab">
                            <form id="newUserForm">
                                <div class="form-group mb-2">
                                    <input class="form-control" placeholder="First Name" name="firstName" required>
                                </div>
                                <div class="form-group mb-2">
                                    <input class="form-control" placeholder="Last Name" name="lastname" required>
                                </div>
                                <div class="form-group mb-2">
                                    <input class="form-control" type="number" placeholder="Age" name="age" required>
                                </div>
                                <div class="form-group mb-2">
                                    <input class="form-control" type="email" placeholder="Email" name="email" required>
                                </div>
                                <div class="form-group mb-2">
                                    <input class="form-control" type="password" placeholder="Password" name="password"
                                           required>
                                </div>
                                <div class="form-group mb-3">
                                    <select multiple class="form-select" name="roles">
                                        <option value="USER">USER</option>
                                        <option value="ADMIN">ADMIN</option>
                                    </select>
                                </div>
                                <button class="btn btn-success" type="submit">Create</button>
                            </form>
                        </div>
                    </div>
                    <div/>
                    <!--Admin-->
<!--                    &lt;!&ndash; User &ndash;&gt;-->
<!--                    <div class="tab-pane fade" id="list-profile" role="tabpanel" aria-labelledby="list-profile-list">-->
<!--                        <p class="lead">-->
<!--                            User Information-Page-->
<!--                        </p>-->
<!--                        <table class="table table-dark table-striped">-->
<!--                            <thead>-->
<!--                            <tr>-->
<!--                                <th>ID</th>-->
<!--                                <th>Имя</th>-->
<!--                                <th>Фамилия</th>-->
<!--                                <th>Возраст</th>-->
<!--                                <th>Email</th>-->
<!--                                <th>Роли</th>-->
<!--                            </tr>-->
<!--                            </thead>-->
<!--                            <tbody>-->
<!--                            <tr>-->
<!--                                <td id="user-id"></td>-->
<!--                                <td id="user-firstname"></td>-->
<!--                                <td id="user-lastname"></td>-->
<!--                                <td id="user-age"></td>-->
<!--                                <td id="user-email"></td>-->
<!--                                <td id="user-roles"></td>-->
<!--                            </tr>-->
<!--                            </tbody>-->
<!--                        </table>-->

<!--                    </div>-->
<!--                    &lt;!&ndash; User &ndash;&gt;-->



                </div>

                    <!-- Scripts -->
                    <script>
                        document.addEventListener("DOMContentLoaded", () => {
                            loadUsers();
                            loadCurrentUser();
                            loadUserInfo();
                            document.getElementById("newUserForm").addEventListener("submit", async (e) => {
                                e.preventDefault();
                                const form = e.target;
                                const data = {
                                    firstName: form.firstName.value,
                                    lastname: form.lastname.value,
                                    age: +form.age.value,
                                    email: form.email.value,
                                    password: form.password.value,
                                    roles: Array.from(form.roles.selectedOptions).map(o => ({name: o.value}))
                                };

                                try {
                                    const res = await fetch("/admin/users", {
                                        method: "POST",
                                        headers: {
                                            "Content-Type": "application/json",
                                            "X-CSRF-TOKEN": getCsrfToken()
                                        },
                                        body: JSON.stringify(data)
                                    });

                                    if (!res.ok) throw new Error("Ошибка при создании пользователя");

                                    form.reset();
                                    document.querySelector('a[href="#usersTab"]').click();
                                    loadUsers();
                                } catch (err) {
                                    alert(err.message);
                                }
                            });
                        });
                        // _______________________
                        function loadUserInfo() {
                            fetch("/user/info")
                                .then(res => res.json())
                                .then(user => {
                                    document.getElementById("user-id").textContent = user.id;
                                    document.getElementById("user-firstname").textContent = user.firstName;
                                    document.getElementById("user-lastname").textContent = user.lastname;
                                    document.getElementById("user-age").textContent = user.age;
                                    document.getElementById("user-email").textContent = user.email;
                                    document.getElementById("user-roles").textContent = user.roles.map(r => r.name.replace("ROLE_", "")).join(", ");
                                });
                        }

                        // ___________________________________
                        function loadUsers() {
                            fetch("/admin/users")
                                .then(res => res.json())
                                .then(users => {
                                    const tableBody = document.getElementById("usersTableBody");
                                    tableBody.innerHTML = "";
                                    users.forEach(user => {
                                        const row = document.createElement("tr");
                                        row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${user.firstName}</td>
                    <td>${user.lastname}</td>
                    <td>${user.age}</td>
                    <td>${user.email}</td>
                    <td>${user.roles.map(r => r.name.replace("ROLE_", "")).join(", ")}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">Delete</button>
                        <button class="btn btn-warning btn-sm" onclick="openEditModal(${user.id})">Edit</button>
                    </td>
                `;
                                        tableBody.appendChild(row);
                                    });
                                });
                        }

                        function deleteUser(id) {
                            if (!confirm("Delete this user?")) return;
                            fetch(`/admin/users/${id}`, {
                                method: "DELETE",
                                headers: {
                                    "X-CSRF-TOKEN": getCsrfToken()
                                }
                            }).then(() => loadUsers());
                        }

                        function getCsrfToken() {
                            return document.querySelector('meta[name="_csrf"]').getAttribute('content');
                        }

                        function openEditModal(userId) {
                            fetch(`/admin/users/${userId}`)
                                .then(res => res.json())
                                .then(user => {
                                    document.getElementById('edit-id').value = user.id;
                                    document.getElementById('edit-firstName').value = user.firstName;
                                    document.getElementById('edit-lastname').value = user.lastname;
                                    document.getElementById('edit-age').value = user.age;
                                    document.getElementById('edit-email').value = user.email;

                                    const rolesSelect = document.getElementById('edit-roles');
                                    Array.from(rolesSelect.options).forEach(option => {
                                        option.selected = user.roles.some(r => r.name === option.value);
                                    });

                                    const modal = new bootstrap.Modal(document.getElementById('editModal'));
                                    modal.show();
                                });
                        }

                        function submitEditForm(event) {
                            event.preventDefault();

                            const id = document.getElementById('edit-id').value;
                            const data = {
                                id: id,
                                firstName: document.getElementById('edit-firstName').value,
                                lastname: document.getElementById('edit-lastname').value,
                                age: +document.getElementById('edit-age').value,
                                email: document.getElementById('edit-email').value,
                                password: document.getElementById('edit-password').value,
                                roles: Array.from(document.getElementById('edit-roles').selectedOptions).map(o => ({name: o.value}))
                            };

                            console.log('Data to update:', data); // Вывод данных, которые отправляются

                            fetch(`/admin/users/${id}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRF-TOKEN': getCsrfToken()
                                },
                                body: JSON.stringify(data)
                            })
                                .then(res => {
                                    if (!res.ok) {
                                        return res.json().then(err => Promise.reject(err));
                                    }
                                    return res.json();
                                })
                                .then(updatedUser => {
                                    console.log('Updated user:', updatedUser); // Вывод обновленного пользователя
                                    bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                                    loadUsers(); // Перезагружаем список пользователей
                                })
                                .catch(err => {
                                    console.error('Error updating user:', err); // Отладочный вывод ошибок
                                    alert("Ошибка обновления: " + JSON.stringify(err));
                                });



                        }
                        function loadCurrentUser() {
                            fetch("/user/user")
                                .then(res => res.json())
                                .then(user => {
                                    document.getElementById("user-id").textContent = user.id;
                                    document.getElementById("user-firstname").textContent = user.firstName;
                                    document.getElementById("user-lastname").textContent = user.lastname;
                                    document.getElementById("user-age").textContent = user.age;
                                    document.getElementById("user-email").textContent = user.email;
                                    document.getElementById("user-roles").textContent = user.roles.map(r => r.name.replace("ROLE_", "")).join(", ");
                                });
                        }



                    </script>

                    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
